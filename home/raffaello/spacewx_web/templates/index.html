<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root {
      --card-bg: #fff;
      --muted:#667085;
      --ring:#e6eaf2;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:16px; color:#111; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap: wrap; }
    .badge { padding:6px 10px; border-radius:999px; background:#eef; font-size:14px; }
    .badge.kp { background:#eef6ff; }
    .badge.tec { background:#f6efff; }
    .badge.pos { background:#effff2; }
    .layout { display:grid; grid-template-columns: 1.6fr 0.9fr; gap:14px; }
    @media (max-width: 1100px){ .layout { grid-template-columns: 1fr; } }
    .cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:12px; }
    .card { background:var(--card-bg); border:1px solid #ddd; border-radius:14px; padding:12px; box-shadow:0 1px 4px rgba(0,0,0,.05); }
    .card h3 { margin:0 0 8px 0; font-size:16px; }
    canvas { width:100%; height:260px; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:6px; text-align:left; }
    .toolbar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .iconbtn { border:1px solid #ddd; background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; }
    .help-panel { position:fixed; inset:auto 16px 16px auto; max-width:420px; max-height:70vh; overflow:auto; background:#fff; border:1px solid #ddd; border-radius:12px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.15); display:none; }
    .help-panel h4 { margin:0 0 8px 0; }
    #map { width:100%; height:420px; border-radius:14px; border:1px solid #ddd; }
    small.muted { color: var(--muted); }


    .day-bar{
      position: sticky; top: 0; z-index: 1200;
      background: #fff; padding: .5rem .75rem; border-bottom: 1px solid #e5e5e5;
      display: flex; gap: .5rem; align-items: center;
    }
    .day-bar button{ padding: .35rem .6rem; border-radius: .5rem; border: 1px solid #ddd; background: #f8f8f8; cursor: pointer; }
    .day-bar input[type="date"]{ padding: .35rem .5rem; }
    .day-label{ margin-left: .5rem; font-weight: 600; opacity: .8; }

    /* Assicurati che il contenitore mappa NON abbia z-index super-alto */
    #map { position: relative; z-index: 1; }

    /* Pannello aiuto sopra tutto */
    #helpPanel{
      position: fixed; /* o absolute se preferisci dentro un container */
      right: 1rem; top: 5rem;
      max-width: 480px;
      background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 10px 24px rgba(0,0,0,.12);
      z-index: 3000;  /* > mappa */
      padding: 1rem;
    }
    #helpPanel[hidden]{ display: none; }

  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <header>
    <h2 style="margin:0;">{{ title }}</h2>
    <span id="kp-badge" class="badge kp">Kp: —</span>
    <span id="tec-badge" class="badge tec">TEC: —</span>
    <span id="pos-badge" class="badge pos">Pos: —</span>
    <div class="toolbar">
      <button id="help-btn" class="iconbtn" title="Cos'è ogni campo?">❓ Aiuto</button>
    </div>
  </header>

  <!-- Top day navigator -->
  <div id="dayBar" class="day-bar">
    <button id="prevDayBtn" aria-label="Giorno precedente">‹</button>
    <input id="dayPicker" type="date">
    <button id="nextDayBtn" aria-label="Giorno successivo">›</button>
    <span id="dayLabel" class="day-label"></span>
  </div>

  <div class="layout">
    <!-- Colonna principale: grafici -->
    <div>
      <div class="cards">
        <div class="card"><h3>TEC (TECU)</h3><canvas id="tec"></canvas></div>
        <div class="card"><h3>Kp</h3><canvas id="kp"></canvas></div>
        <div class="card"><h3>HDOP</h3><canvas id="hdop"></canvas></div>
        <div class="card"><h3>PDOP</h3><canvas id="pdop"></canvas></div>
        <div class="card"><h3>VDOP</h3><canvas id="vdop"></canvas></div>
        <div class="card"><h3>C/N₀ medio (dB‑Hz)</h3><canvas id="cn0"></canvas></div>
        <div class="card"><h3>Satelliti usati</h3><canvas id="svused"></canvas></div>
        <div class="card"><h3>Noise 2.4 GHz (dBm)</h3><canvas id="noise24"></canvas></div>
        <div class="card"><h3>Noise 5.8 GHz (dBm)</h3><canvas id="noise58"></canvas></div>
        <div class="card"><h3>Scan p50 RSSI 2.4 GHz</h3><canvas id="scan24"></canvas></div>
        <div class="card"><h3>Scan p50 RSSI 5.8 GHz</h3><canvas id="scan58"></canvas></div>
      </div>
    </div>

    <!-- Colonna destra: mappa + evidenze -->
    <div>
      <div class="card">
        <h3>Mappa GPS (trail)</h3>
        <div id="map"></div>
        <small class="muted">La scia evidenzia gli spostamenti. Se presenti disturbi EM, ci si aspetta maggiore erraticità della traccia.</small>
      </div>
      <div class="card">
        <h3>Evidenze Quiet vs Storm</h3>
        <table id="ev-table"><thead>
          <tr><th>Banda</th><th>Metrica</th><th>Quiet med</th><th>Storm med</th><th>Δ</th></tr>
        </thead><tbody></tbody></table>
        <small class="muted">Le mediane richiedono dati sufficienti in entrambi i regimi.</small>
      </div>
    </div>
  </div>

  <!-- Help / Glossario -->
  <div id="help" class="help-panel">
    <h4>Glossario campi</h4>
    <div id="help-body"><small class="muted">Caricamento…</small></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script> -->
   
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/static/dashboard.js"></script>
</body>
</html>