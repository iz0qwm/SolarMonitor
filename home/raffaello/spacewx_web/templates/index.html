<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root {
      --card-bg: #fff;
      --muted:#667085;
      --ring:#e6eaf2;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:16px; color:#111; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap: wrap; }
    .badge { padding:6px 10px; border-radius:999px; background:#eef; font-size:14px; }
    .badge.kp { background:#eef6ff; }
    .badge.tec { background:#f6efff; }
    .badge.pos { background:#effff2; }
    .layout { display:grid; grid-template-columns: 1.6fr 0.9fr; gap:14px; }
    @media (max-width: 1100px){ .layout { grid-template-columns: 1fr; } }
    .cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:12px; }
    .card { background:var(--card-bg); border:1px solid #ddd; border-radius:14px; padding:12px; box-shadow:0 1px 4px rgba(0,0,0,.05); }
    .card h3 { margin:0 0 8px 0; font-size:16px; }
    canvas { width:100%; height:260px; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:6px; text-align:left; }
    .toolbar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .iconbtn { border:1px solid #ddd; background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; }
    #map { width:100%; height:420px; border-radius:14px; border:1px solid #ddd; }
    small.muted { color: var(--muted); }

    .badge { padding:6px 10px; border-radius:999px; background:#eef; font-size:14px; }
    .badge.kp, .badge.tec { color: #111; }

    .day-bar{
      position: sticky; top: 0; z-index: 1200;
      background: #fff; padding: .5rem .75rem; border-bottom: 1px solid #e5e5e5;
      display: flex; gap: .5rem; align-items: center;
    }
    .day-bar button{ padding: .35rem .6rem; border-radius: .5rem; border: 1px solid #ddd; background: #f8f8f8; cursor: pointer; }
    .day-bar input[type="date"]{ padding: .35rem .5rem; }
    .day-label{ margin-left: .5rem; font-weight: 600; opacity: .8; }

    /* Assicurati che il contenitore mappa NON abbia z-index super-alto */
    #map { position: relative; z-index: 1; }

    header { display:flex; align-items:flex-start; gap:12px; margin-bottom:12px; flex-wrap: wrap; }
    header .title { flex: 1 0 100%; }             /* forza a nuova riga */
    header .status-row { display:flex; gap:12px; align-items:center; width:100%; }
    .toolbar { margin-left:auto; display:flex; gap:8px; align-items:center; } /* già presente, ok */


    
    /* Pannello Aiuto: a DESTRA, sotto header/day-bar */
    .help-panel{
      position: fixed;
      right: 1rem;        /* → destra */
      left: auto;
      top: 9rem;          /* sotto header + day bar */
      max-width: 480px;
      max-height: 70vh;
      overflow: auto;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 12px 40px 12px 12px;  /* spazio per la 'X' */
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      z-index: 3000;
      display: none;
    }
    .help-panel .close-btn{
      position: absolute; top: 6px; right: 8px;
      font-size: 20px; line-height: 1;
      background: transparent; border: none; cursor: pointer; padding: 4px 6px;
    }
    .help-panel .close-btn:focus { outline: 2px solid #555; border-radius: 6px; }

    small.muted { max-width: 1100px; }

    /* Chip colore nel pannello Help */
    .chip{
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(0,0,0,.06);
      margin-left: .35rem;
    }
    .chip-green  { background:#C7F2C8; color:#0B3D0B; }
    .chip-yellow { background:#FFF3B0; color:#5C4800; }
    .chip-lo     { background:#FFD8A8; color:#5A3A00; } /* light orange */
    .chip-orange { background:#FFC078; color:#5A2A00; }
    .chip-lred   { background:#FFA8A8; color:#5A0B0B; }
    .chip-red    { background:#FF6B6B; color:#fff; }
    .help-panel h5{ margin:10px 0 6px 0; }
    .help-panel ul{ margin: 6px 0 10px 1.1rem; padding:0; }
    .help-footer{ margin-top:10px; }
    .help-footer a{ text-decoration:none; }

    /* Overlay di caricamento */
    #loading {
      position: fixed; inset: 0; background: rgba(255,255,255,.9);
      display: none; z-index: 5000; align-items: center; justify-content: center;
    }
    .loading-box{
      width: min(720px, 92vw);
      background: #fff; border:1px solid #ddd; border-radius: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.15); padding: 14px;
    }
    .loading-head{ display:flex; align-items:center; gap:.6rem; margin-bottom:.5rem;}
    .loading-dot{ width:10px; height:10px; border-radius:50%; background:#6aa0ff; animation: pulse 1s infinite; }
    @keyframes pulse { 0%{opacity:.3} 50%{opacity:1} 100%{opacity:.3} }
    #loading-log{
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#f7f8fa; border:1px solid #e6eaf2; padding:8px; border-radius:8px;
      max-height: 45vh; overflow:auto; white-space: pre-wrap;
    }

    @keyframes pulse { 0%{opacity:.3} 50%{opacity:1} 100%{opacity:.3} }
    
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <header>
    <div class="title">
      <h2 style="margin:0;">{{ title }}</h2>
      <small class="muted" style="display:block; margin-top:4px; line-height:1.35;">
        Pagina di utilità per piloti remoti di UAV.<br>
        Monitor locale di qualità GPS/GNSS (TEC, DOP, satelliti) e rumore/occupazione Wi-Fi.<br>
        L’indice <strong>Kp</strong> misura l’attività geomagnetica (tempeste solari), ma alle medie latitudini non sempre anticipa disturbi al GPS.<br>
        Il <strong>TEC</strong> (Total Electron Content) è più direttamente legato alla propagazione ionosferica e quindi all’accuratezza GNSS. Le bande 2.4/5-6 GHz degli UAV sono in genere poco influenzate, ma le monitoriamo per correlare eventuali degradi locali.
      </small>
    </div>


    <div class="status-row">
      <span id="kp-badge"  class="badge kp"  title="Kp: indice di attività geomagnetica (tempeste solari).">Kp: —</span>
      <span id="tec-badge" class="badge tec" title="TEC: contenuto elettronico ionosferico (più legato a precisione/affidabilità GNSS).">TEC: —</span>
      <span id="pos-badge" class="badge pos" title="Fix e coordinate GNSS locali.">Pos: —</span>

      <div class="toolbar">
        <button id="help-btn" class="iconbtn" title="Cos'è ogni campo?">❓ Aiuto</button>
      </div>
    </div>
  </header>



  <!-- Top day navigator -->
  <div id="dayBar" class="day-bar">
    <button id="prevDayBtn" aria-label="Giorno precedente">‹</button>
    <input id="dayPicker" type="date">
    <button id="nextDayBtn" aria-label="Giorno successivo">›</button>
    <span id="dayLabel" class="day-label"></span>
  </div>

  <div class="layout">
    <!-- Colonna principale: grafici -->
    <div>
      <div class="cards">
        <div class="card"><h3>TEC (TECU)</h3><canvas id="tec"></canvas></div>
        <div class="card"><h3>Kp</h3><canvas id="kp"></canvas></div>
        <div class="card"><h3>HDOP</h3><canvas id="hdop"></canvas></div>
        <div class="card"><h3>PDOP</h3><canvas id="pdop"></canvas></div>
        <div class="card"><h3>VDOP</h3><canvas id="vdop"></canvas></div>
        <div class="card"><h3>C/N₀ medio (dB‑Hz)</h3><canvas id="cn0"></canvas></div>
        <div class="card"><h3>Satelliti usati</h3><canvas id="svused"></canvas></div>
        <div class="card"><h3>Noise 2.4 GHz (dBm)</h3><canvas id="noise24"></canvas></div>
        <div class="card"><h3>Noise 5.8 GHz (dBm)</h3><canvas id="noise58"></canvas></div>
        <div class="card"><h3>Busy ratio 2.4 GHz</h3><canvas id="busy24"></canvas></div>
        <div class="card"><h3>Busy ratio 5.8 GHz</h3><canvas id="busy58"></canvas></div>
        <div class="card"><h3>Scan p50 RSSI 2.4 GHz</h3><canvas id="scan24"></canvas></div>
        <div class="card"><h3>Scan p50 RSSI 5.8 GHz</h3><canvas id="scan58"></canvas></div>
      </div>
    </div>

    <!-- Colonna destra: mappa + evidenze -->
    <div>
      <div class="card">
        <h3>Mappa GPS (trail)</h3>
        <div id="map"></div>
        <small class="muted">La scia evidenzia gli spostamenti. Se presenti disturbi EM, ci si aspetta maggiore erraticità della traccia.</small>
      </div>
      <div class="card">
        <h3>Evidenze Quiet vs Storm</h3>
        <table id="ev-table"><thead>
          <tr><th>Banda</th><th>Metrica</th><th>Quiet med</th><th>Storm med</th><th>Δ</th></tr>
        </thead><tbody></tbody></table>
        <small class="muted">Le mediane richiedono dati sufficienti in entrambi i regimi.</small>
      </div>
    </div>
  </div>

  <!-- Help / Glossario -->
  <div id="help" class="help-panel">
    <button id="help-close" class="close-btn" aria-label="Chiudi pannello">×</button>
    <h4>Guida rapida & Glossario</h4>

    <!-- Sezione fissa: Come leggere i badge -->
    <section id="help-badges">
      <h5>Come leggere i badge</h5>

      <p><b>Kp</b> — indice di attività geomagnetica (tempeste solari), utile come contesto generale.</p>
      <ul>
        <li>Kp &lt; 5 <span class="chip chip-green">Verde</span></li>
        <li>Kp = 5 (G1) <span class="chip chip-yellow">Giallo</span></li>
        <li>Kp = 6 (G2) <span class="chip chip-lo">Arancio chiaro</span></li>
        <li>Kp = 7 (G3) <span class="chip chip-orange">Arancione</span></li>
        <li>Kp = 8, 9− (G4) <span class="chip chip-lred">Rosso chiaro</span></li>
        <li>Kp = 9.0 (G5) <span class="chip chip-red">Rosso</span></li>
      </ul>

      <p><b>TEC (TECu)</b> — contenuto totale di elettroni nella ionosfera, più correlato a errori/instabilità GNSS.</p>
      <ul>
        <li><b>Quiet</b>: sTEC &lt; 125 <span class="chip chip-green">Verde</span></li>
        <li><b>Moderate</b>: sTEC ≥ 125 <span class="chip chip-orange">Arancione</span></li>
        <li><b>Severe</b>: sTEC ≥ 175 <span class="chip chip-red">Rosso</span></li>
      </ul>
      <hr>
    </section>

    <!-- Sezione dinamica: Glossario (riempita da dashboard.js) -->
    <h5>Glossario campi</h5>
    <div id="help-glossary"><small class="muted">Caricamento…</small></div>

    <hr>
    <div class="help-footer">
      <a href="https://github.com/iz0qwm/SolarMonitor/" target="_blank" rel="noopener">
        Codice sorgente su GitHub: iz0qwm/SolarMonitor ↗
      </a>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script> -->
   
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/static/dashboard.js"></script>

<div id="loading" role="dialog" aria-live="polite" aria-label="Caricamento dati"
     style="position:fixed;inset:0;display:none;z-index:5000;align-items:center;justify-content:center;background:rgba(255,255,255,.9)">
  <div class="loading-box" style="width:min(720px,92vw);background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 18px 50px rgba(0,0,0,.15);padding:14px;">
    <div class="loading-head" style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;">
      <div class="loading-dot" style="width:10px;height:10px;border-radius:50%;background:#6aa0ff;animation:pulse 1s infinite"></div>
      <strong id="loading-title">Caricamento…</strong>
      <span id="loading-sub" style="margin-left:.25rem;color:#666;font-size:12px"></span>
    </div>
    <div id="loading-log"
         style="font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;background:#f7f8fa;border:1px solid #e6eaf2;padding:8px;border-radius:8px;max-height:45vh;overflow:auto;white-space:pre-wrap;">
      Avvio…
    </div>
  </div>
</div>


</body>
</html>